<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Well Depth Lookup - SCWS</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            color: #333;
            line-height: 1.5;
        }
        .container { max-width: 800px; margin: 0 auto; padding: 20px; }
        header {
            background: #1f3b4d;
            color: white;
            padding: 20px;
            text-align: center;
            margin-bottom: 20px;
            border-radius: 8px;
        }
        header h1 { font-size: 1.5rem; margin-bottom: 5px; }
        header p { opacity: 0.8; font-size: 0.9rem; }
        .data-badge {
            display: inline-block;
            background: #4e9271;
            color: white;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            margin-top: 10px;
        }
        .search-box {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .search-box label { display: block; margin-bottom: 8px; font-weight: 600; }
        .search-row { display: flex; gap: 10px; }
        .search-box input[type="text"] {
            flex: 1;
            padding: 12px 15px;
            font-size: 16px;
            border: 2px solid #ddd;
            border-radius: 6px;
        }
        .search-box input:focus { outline: none; border-color: #4e9271; }
        .search-box button {
            padding: 12px 24px;
            font-size: 16px;
            background: #4e9271;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
        }
        .search-box button:hover { background: #3d7a5c; }
        .search-box button:disabled { background: #ccc; cursor: not-allowed; }
        .options { display: flex; gap: 20px; margin-top: 15px; flex-wrap: wrap; }
        .options label { display: flex; align-items: center; gap: 5px; font-size: 0.9rem; }
        .options select { padding: 5px 10px; border-radius: 4px; border: 1px solid #ddd; }
        .loading { text-align: center; padding: 40px; color: #666; }
        .error { background: #fee; border: 1px solid #fcc; color: #c00; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .stats-box { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .stats-box h2 { font-size: 1.1rem; margin-bottom: 15px; color: #1f3b4d; }
        .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; }
        .stat-item { text-align: center; padding: 15px; background: #f8f8f8; border-radius: 6px; }
        .stat-value { font-size: 1.5rem; font-weight: 700; color: #1f3b4d; }
        .stat-label { font-size: 0.8rem; color: #666; }
        .estimate-box { background: linear-gradient(135deg, #1f3b4d, #2d5a73); color: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        .estimate-box h3 { margin-bottom: 10px; }
        .estimate-range { font-size: 1.8rem; font-weight: 700; margin-bottom: 10px; }
        .estimate-note { font-size: 0.85rem; opacity: 0.8; }
        .wells-list { background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .wells-list h3 { padding: 15px 20px; border-bottom: 1px solid #eee; font-size: 1rem; }
        .well-card { padding: 15px 20px; border-bottom: 1px solid #f0f0f0; }
        .well-card:last-child { border-bottom: none; }
        .well-card .header { display: flex; justify-content: space-between; margin-bottom: 8px; }
        .well-card .depth { font-size: 1.3rem; font-weight: 700; color: #1f3b4d; }
        .well-card .distance { font-size: 0.85rem; color: #666; background: #eee; padding: 3px 8px; border-radius: 10px; }
        .well-card .details { font-size: 0.9rem; color: #555; }
        .well-card .details span { display: inline-block; margin-right: 15px; }
        .cta-box { background: #4e9271; color: white; padding: 20px; border-radius: 8px; text-align: center; margin-top: 20px; }
        .cta-box h3 { margin-bottom: 10px; }
        .cta-box a { display: inline-block; background: white; color: #4e9271; padding: 12px 24px; border-radius: 6px; text-decoration: none; font-weight: 600; margin-top: 10px; }
        @media (max-width: 600px) {
            .search-row { flex-direction: column; }
            .stats-grid { grid-template-columns: 1fr 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>‚õèÔ∏è Well Depth Lookup</h1>
            <p>Southern California Well Service</p>
            <div class="data-badge" id="dataBadge">Loading data...</div>
        </header>
        
        <div class="search-box">
            <label for="address">Enter Property Address</label>
            <div class="search-row">
                <input type="text" id="address" placeholder="123 Main St, Ramona, CA 92065" autocomplete="off">
                <button id="searchBtn" onclick="search()" disabled>Loading...</button>
            </div>
            <p style="margin-top: 10px; font-size: 0.85rem; color: #666;">üí° <strong>Tip:</strong> Include your <strong>zip code</strong> for best results. Well depths can vary significantly even within a few miles.</p>
            <div class="options">
                <label>Radius: <select id="radius">
                    <option value="0.5" selected>0.5 miles</option>
                    <option value="1">1 mile</option>
                    <option value="2">2 miles</option>
                    <option value="5">5 miles</option>
                </select></label>
            </div>
        </div>
        
        <div id="loading" class="loading" style="display: none;">Searching wells...</div>
        <div id="error" class="error" style="display: none;"></div>
        <div id="results" style="display: none;"></div>
    </div>

    <script>
        const NOMINATIM_API = 'https://nominatim.openstreetmap.org/search';
        let LOCAL_WELLS = null;
        
        // Load local well data on startup
        async function loadLocalData() {
            try {
                const resp = await fetch('well_data.json');
                const data = await resp.json();
                LOCAL_WELLS = data.wells;
                document.getElementById('dataBadge').textContent = `‚úì ${data.count.toLocaleString()} wells loaded`;
                document.getElementById('searchBtn').disabled = false;
                document.getElementById('searchBtn').textContent = 'Search';
                console.log(`Loaded ${data.count} wells from local database`);
            } catch (e) {
                document.getElementById('dataBadge').textContent = '‚ö† Data failed to load';
                document.getElementById('searchBtn').textContent = 'Search';
                document.getElementById('searchBtn').disabled = false;
                console.log('Local data not available:', e);
            }
        }
        loadLocalData();
        
        document.getElementById('address').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') search();
        });
        
        async function search() {
            const address = document.getElementById('address').value.trim();
            
            if (!address) { showError('Please enter an address'); return; }
            
            if (!LOCAL_WELLS) {
                showError('Well data is still loading. Please wait a few seconds and try again.');
                return;
            }
            
            showLoading(true);
            hideError();
            hideResults();
            
            try {
                const coords = await geocode(address);
                // Re-read radius in case fallback expanded it
                const currentRadius = parseFloat(document.getElementById('radius').value);
                const wells = queryLocalWells(coords.lat, coords.lon, currentRadius);
                const analysis = analyzeWells(wells, coords.lat, coords.lon);
                analysis.location = coords.display;
                analysis.coords = coords;
                analysis.radius = currentRadius;
                analysis.fallback = coords.fallback;
                showResults(analysis);
            } catch (err) {
                showError(err.message);
            } finally {
                showLoading(false);
            }
        }
        
        async function geocode(address) {
            const params = new URLSearchParams({ q: address, format: 'json', limit: 1, countrycodes: 'us' });
            const resp = await fetch(`${NOMINATIM_API}?${params}`, { headers: { 'User-Agent': 'WellDepthLookup/1.0' } });
            let data = await resp.json();
            let fallback = false;
            
            // If exact address not found, try zip code first (most accurate fallback)
            // Use the LAST 5-digit number (zip codes come after street numbers)
            if (!data.length) {
                const allZips = address.match(/\b\d{5}\b/g);
                const zipCode = allZips ? allZips[allZips.length - 1] : null;
                if (zipCode) {
                    const zipParams = new URLSearchParams({ q: zipCode, format: 'json', limit: 1, countrycodes: 'us' });
                    const zipResp = await fetch(`${NOMINATIM_API}?${zipParams}`, { headers: { 'User-Agent': 'WellDepthLookup/1.0' } });
                    data = await zipResp.json();
                    if (data.length) fallback = true;
                }
            }
            
            // Try city, state if still not found (with commas)
            if (!data.length) {
                const cityMatch = address.match(/,\s*([^,]+),\s*([A-Z]{2})/i);
                if (cityMatch) {
                    const cityParams = new URLSearchParams({ q: `${cityMatch[1]}, ${cityMatch[2]}`, format: 'json', limit: 1, countrycodes: 'us' });
                    const cityResp = await fetch(`${NOMINATIM_API}?${cityParams}`, { headers: { 'User-Agent': 'WellDepthLookup/1.0' } });
                    data = await cityResp.json();
                    if (data.length) fallback = true;
                }
            }
            
            // Try extracting city name WITHOUT commas (e.g., "123 main st ramona ca")
            if (!data.length) {
                // Common CA cities in well drilling areas - expanded list
                const knownCities = ['ramona', 'aguanga', 'escondido', 'valley center', 'fallbrook', 'temecula', 
                    'murrieta', 'poway', 'alpine', 'jamul', 'descanso', 'julian', 'borrego springs',
                    'hemet', 'winchester', 'anza', 'idyllwild', 'lake elsinore', 'wildomar',
                    'apple valley', 'lucerne valley', 'hesperia', 'victorville', 'yucca valley',
                    'twentynine palms', 'joshua tree', 'morongo valley', 'pioneertown',
                    'perris', 'menifee', 'san jacinto', 'banning', 'beaumont', 'cherry valley',
                    'nuevo', 'lakeview', 'homeland', 'romoland', 'lakeside', 'el cajon',
                    'campo', 'potrero', 'pine valley', 'boulevard', 'jacumba', 'ocotillo',
                    'warner springs', 'santa ysabel', 'ranchita', 'oak grove'];
                const lowerAddr = address.toLowerCase();
                for (const city of knownCities) {
                    if (lowerAddr.includes(city)) {
                        const cityParams = new URLSearchParams({ q: `${city}, CA`, format: 'json', limit: 1, countrycodes: 'us' });
                        const cityResp = await fetch(`${NOMINATIM_API}?${cityParams}`, { headers: { 'User-Agent': 'WellDepthLookup/1.0' } });
                        data = await cityResp.json();
                        if (data.length) { fallback = true; break; }
                    }
                }
            }
            
            // Last resort: try the last 2-3 words before "ca" or "california"
            if (!data.length) {
                const lastWordsMatch = address.match(/(\w+(?:\s+\w+)?)\s+(?:ca|california)\s*$/i);
                if (lastWordsMatch) {
                    const cityParams = new URLSearchParams({ q: `${lastWordsMatch[1]}, CA`, format: 'json', limit: 1, countrycodes: 'us' });
                    const cityResp = await fetch(`${NOMINATIM_API}?${cityParams}`, { headers: { 'User-Agent': 'WellDepthLookup/1.0' } });
                    data = await cityResp.json();
                    if (data.length) fallback = true;
                }
            }
            
            if (!data.length) throw new Error('Could not find that location. Try adding your zip code or just enter the city name (e.g., "Aguanga, CA 92536").');
            
            // If we had to fall back, auto-expand radius to 2 miles and notify user
            if (fallback) {
                document.getElementById('radius').value = '2';
            }
            
            return { lat: parseFloat(data[0].lat), lon: parseFloat(data[0].lon), display: data[0].display_name, fallback };
        }
        
        function queryLocalWells(lat, lon, radiusMiles) {
            if (!LOCAL_WELLS) return [];
            return LOCAL_WELLS.filter(w => {
                const dist = calcDistance(lat, lon, w.lat, w.lon);
                return dist <= radiusMiles;
            }).map(w => ({
                TotalCompletedDepth: w.depth,
                DecimalLatitude: w.lat,
                DecimalLongitude: w.lon,
                City: w.city,
                WellYield: w.yield,
                CasingDiameter: w.casing,
                WCRNumber: w.wcr
            }));
        }
        
        function calcDistance(lat1, lon1, lat2, lon2) {
            const R = 3959;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180) * Math.cos(lat2*Math.PI/180) * Math.sin(dLon/2)**2;
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }
        
        function analyzeWells(wells, centerLat, centerLon) {
            if (!wells.length) return { wells: [], stats: null };
            
            // Calculate distance for each well first
            wells.forEach(w => {
                w._distance = calcDistance(centerLat, centerLon, w.DecimalLatitude, w.DecimalLongitude);
                w._depth = w.TotalCompletedDepth || w.TotalDrillDepth;
            });
            wells.sort((a, b) => a._distance - b._distance);
            
            // Filter valid depths and yields
            const wellsWithDepth = wells.filter(w => w._depth > 0);
            const yields = wells.map(w => w.WellYield).filter(y => y > 0);
            
            // Inverse distance weighted average for depth (closer wells count more)
            let weightedDepth = null;
            if (wellsWithDepth.length) {
                let totalWeight = 0;
                let weightedSum = 0;
                wellsWithDepth.forEach(w => {
                    // Weight = 1 / (distance + 0.1)^2  (0.1 prevents division by zero for very close wells)
                    const weight = 1 / Math.pow(w._distance + 0.1, 2);
                    weightedSum += w._depth * weight;
                    totalWeight += weight;
                });
                weightedDepth = Math.round(weightedSum / totalWeight);
            }
            
            const depths = wellsWithDepth.map(w => w._depth);
            
            return {
                wells: wells.slice(0, 20),
                stats: {
                    count: wells.length,
                    avgDepth: weightedDepth,
                    minDepth: depths.length ? Math.min(...depths) : null,
                    maxDepth: depths.length ? Math.max(...depths) : null,
                    medianDepth: depths.length ? depths.sort((a,b)=>a-b)[Math.floor(depths.length/2)] : null,
                    avgYield: yields.length ? Math.round(yields.reduce((a,b)=>a+b,0)/yields.length) : null
                }
            };
        }
        
        function showResults(analysis) {
            const { wells, stats, location, radius, fallback } = analysis;
            const resultsDiv = document.getElementById('results');
            
            if (!wells.length) {
                resultsDiv.innerHTML = `<div class="stats-box"><p>No wells found within ${radius} mile(s). Try increasing the search radius.</p></div>`;
                resultsDiv.style.display = 'block';
                return;
            }
            
            const costLow = stats.avgDepth * 50;
            const costHigh = stats.avgDepth * 80;
            
            let html = `
                <div class="stats-box">
                    <h2>üìä Well Data for This Area</h2>
                    ${fallback ? '<p style="margin-bottom:10px;color:#b45309;font-size:0.85rem;background:#fef3c7;padding:8px 12px;border-radius:6px;">‚ö†Ô∏è Exact address not found ‚Äî showing results for general area. Add your zip code for better accuracy.</p>' : ''}
                    <p style="margin-bottom:15px;color:#666;font-size:0.9rem;">Based on ${stats.count} wells within ${radius} mile(s) (closer wells weighted more heavily)</p>
                    <div class="stats-grid">
                        <div class="stat-item"><div class="stat-value">${stats.avgDepth}'</div><div class="stat-label">Avg Depth</div></div>
                        <div class="stat-item"><div class="stat-value">${stats.minDepth}'-${stats.maxDepth}'</div><div class="stat-label">Depth Range</div></div>
                        <div class="stat-item"><div class="stat-value">${stats.avgYield || 'N/A'}</div><div class="stat-label">Avg GPM</div></div>
                    </div>
                </div>
                <div class="estimate-box">
                    <h3>üí∞ Estimated Drilling Cost</h3>
                    <div class="estimate-range">$${costLow.toLocaleString()} - $${costHigh.toLocaleString()}</div>
                    <div class="estimate-note">Based on ${stats.avgDepth}' average depth √ó $50-80/foot. Actual costs vary by conditions.</div>
                </div>
                <div class="wells-list">
                    <h3>üîç Nearby Wells (${wells.length} shown)</h3>
                    ${wells.map(w => `
                        <div class="well-card">
                            <div class="header">
                                <span class="depth">${w.TotalCompletedDepth || w.TotalDrillDepth}' deep</span>
                                <span class="distance">${w._distance.toFixed(2)} mi</span>
                            </div>
                            <div class="details">
                                ${w.City ? `<span>üìç ${w.City}</span>` : ''}
                                ${w.WellYield ? `<span>üíß ${w.WellYield} GPM</span>` : ''}
                                ${w.CasingDiameter ? `<span>‚≠ï ${w.CasingDiameter}" casing</span>` : ''}
                            </div>
                        </div>
                    `).join('')}
                </div>
                <div class="cta-box">
                    <h3>Ready for an Accurate Quote?</h3>
                    <p>This estimate is based on nearby well data. Contact us for a site-specific assessment.</p>
                    <a href="tel:7604408520">Call (760) 440-8520</a>
                </div>
            `;
            
            resultsDiv.innerHTML = html;
            resultsDiv.style.display = 'block';
        }
        
        function showLoading(show) { document.getElementById('loading').style.display = show ? 'block' : 'none'; }
        function showError(msg) { const el = document.getElementById('error'); el.textContent = msg; el.style.display = 'block'; }
        function hideError() { document.getElementById('error').style.display = 'none'; }
        function hideResults() { document.getElementById('results').style.display = 'none'; }
    </script>
</body>
</html>
